<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/SimilaritySearchDemos/libs/katex/katex.min.css"> <link rel=stylesheet  href="/SimilaritySearchDemos/libs/highlight/github.min.css"> <link rel=stylesheet  href="/SimilaritySearchDemos/css/franklin.css"> <link rel=stylesheet  href="/SimilaritySearchDemos/css/pure.css"> <link rel=stylesheet  href="/SimilaritySearchDemos/css/side-menu.css"> <style> .franklin-content{padding-left:10%;} @media (min-width: 940px) { .franklin-content {width: 640px; margin-left: 0px; padding-left: 80px;} .header {width: 700px;} } </style> <link rel=icon  href="/SimilaritySearchDemos/assets/favicon.png"> <title>Solving single queries</title> <div id=layout > <a href="#menu" id=menuLink  class=menu-link ><span></span></a> <div id=menu > <div class=pure-menu > <a class=pure-menu-heading  href="#">Menu</a> <ul class=pure-menu-list > <li class="pure-menu-item "><a href="/SimilaritySearchDemos/" class=pure-menu-link >Home</a> <li class="pure-menu-item "><a href="/SimilaritySearchDemos/tutorials/" class=pure-menu-link >Tutorials</a> <li class="pure-menu-item "><a href="/SimilaritySearchDemos/demos/" class=pure-menu-link >Demonstrations</a> <li class="pure-menu-item "><a href="/SimilaritySearchDemos/datasets/" class=pure-menu-link >Datasets</a> <li class="pure-menu-item "><a href="/SimilaritySearchDemos/tags/" class=pure-menu-link >Tags</a> </ul> </div> </div> <div id=main > <div class=header > <h1>Solving single queries</h1> <h2>Usage demonstrations of `SimilaritySearch` with synthetic and real world data</h2> </div> <div class=franklin-content ><div class=franklin-toc ><ol><li><a href="#solving_single_queries_and_knnresult">Solving single queries and <code>KnnResult</code></a><li><a href="#knnresult"><code>KnnResult</code></a><li><a href="#dependencies">Dependencies</a></ol></div> <h2 id=solving_single_queries_and_knnresult ><a href="#solving_single_queries_and_knnresult" class=header-anchor >Solving single queries and <code>KnnResult</code></a></h2> <p>By Eric S. TÃ©llez</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> SimilaritySearch</code></pre>
<p>This example shows how to perform single queries instead of solving a batch of them. This is particularly useful for some applications, and we also show how they are solved, which could be used to avoid some memory allocations.</p>
<pre><code class="julia hljs"><span class=hljs-keyword >const</span> dim = <span class=hljs-number >8</span>

db = MatrixDatabase(randn(<span class=hljs-built_in >Float32</span>, dim, <span class=hljs-number >10</span>^<span class=hljs-number >4</span>))
dist = SqL2Distance()
G = SearchGraph(; dist, db, verbose=<span class=hljs-literal >false</span>)
index!(G)</code></pre>
<p>Suppose you want to compute some <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> nearest neighbors, for this we use the structure <code>KnnResult</code> which is a priority queue of maximum size <code>k</code>.</p>
<pre><code class="julia hljs">res = KnnResult(<span class=hljs-number >3</span>) <span class=hljs-comment ># allocates memory for 10 nearest neighbors</span>
<span class=hljs-keyword >for</span> v <span class=hljs-keyword >in</span> rand(db, <span class=hljs-number >10</span>)
    <span class=hljs-keyword >global</span> res = reuse!(res)  <span class=hljs-comment ># reuses the res object</span>
    <span class=hljs-meta >@time</span> search(G, v, res)
    <span class=hljs-meta >@show</span> minimum(res), maximum(res), argmin(res), argmax(res)
    <span class=hljs-meta >@show</span> res.id, res.dist
<span class=hljs-keyword >end</span></code></pre><pre><code class="plaintext hljs">  0.000014 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 0.8905508f0, 2128, 1443)
(res.id, res.dist) = (Int32[2128, 8344, 1443], Float32[0.0, 0.84609, 0.8905508])
  0.000017 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 1.6256907f0, 2423, 2429)
(res.id, res.dist) = (Int32[2423, 9745, 2429], Float32[0.0, 1.4638197, 1.6256907])
  0.000003 seconds (3 allocations: 80 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (4.78367f0, 5.1175313f0, 4013, 1596)
(res.id, res.dist) = (Int32[4013, 4263, 1596], Float32[4.78367, 4.8129697, 5.1175313])
  0.000008 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 0.41689724f0, 9146, 9665)
(res.id, res.dist) = (Int32[9146, 7734, 9665], Float32[0.0, 0.40764204, 0.41689724])
  0.000009 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 0.58236307f0, 7017, 8663)
(res.id, res.dist) = (Int32[7017, 7083, 8663], Float32[0.0, 0.5803072, 0.58236307])
  0.000006 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 1.6216689f0, 1204, 4870)
(res.id, res.dist) = (Int32[1204, 7732, 4870], Float32[0.0, 1.2965301, 1.6216689])
  0.000003 seconds (3 allocations: 80 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (4.8486495f0, 5.066002f0, 9337, 1662)
(res.id, res.dist) = (Int32[9337, 4890, 1662], Float32[4.8486495, 4.9212174, 5.066002])
  0.000009 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 0.6915525f0, 6818, 1745)
(res.id, res.dist) = (Int32[6818, 4908, 1745], Float32[0.0, 0.2793303, 0.6915525])
  0.000009 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 1.7419999f0, 377, 8083)
(res.id, res.dist) = (Int32[377, 4924, 8083], Float32[0.0, 1.697232, 1.7419999])
  0.000009 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 0.90013003f0, 8798, 6576)
(res.id, res.dist) = (Int32[8798, 1536, 6576], Float32[0.0, 0.87009954, 0.90013003])
</code></pre>
<h2 id=knnresult ><a href="#knnresult" class=header-anchor ><code>KnnResult</code></a></h2>
<p>This structure is the container for the result and it is also used to specify the number of elements to retrieve. As mentioned before, it is a priority queue</p>
<pre><code class="julia hljs">res = reuse!(res)
push!(res, <span class=hljs-number >1</span>, <span class=hljs-number >10</span>)
push!(res, <span class=hljs-number >2</span>, <span class=hljs-number >9</span>)
push!(res, <span class=hljs-number >3</span>, <span class=hljs-number >8</span>)
push!(res, <span class=hljs-number >4</span>, <span class=hljs-number >7</span>)
push!(res, <span class=hljs-number >6</span>, <span class=hljs-number >5</span>)
<span class=hljs-meta >@show</span> res</code></pre><pre><code class="plaintext hljs">res = SimilaritySearch.KnnResult(Int32[6, 4, 3], Float32[5.0, 7.0, 8.0], 3)
</code></pre>
<p>it also supports removals</p>
<pre><code class="julia hljs"><span class=hljs-meta >@show</span> :popfirst! =&gt; popfirst!(res)
push!(res, <span class=hljs-number >7</span>, <span class=hljs-number >0.1</span>)
<span class=hljs-meta >@show</span> :push! =&gt; res
<span class=hljs-meta >@show</span> :pop! =&gt; pop!(res)
res</code></pre><pre><code class="plaintext hljs">:popfirst! =&gt; popfirst!(res) = :popfirst! =&gt; (6 =&gt; 5.0f0)
:push! =&gt; res = :push! =&gt; SimilaritySearch.KnnResult(Int32[7, 4, 3], Float32[0.1, 7.0, 8.0], 3)
:pop! =&gt; pop!(res) = :pop! =&gt; (3 =&gt; 8.0f0)
SimilaritySearch.KnnResult(Int32[7, 4], Float32[0.1, 7.0], 3)</code></pre>
<p>It can be iterated</p>
<pre><code class="julia hljs"><span class=hljs-keyword >for</span> (id, d) <span class=hljs-keyword >in</span> res
    <span class=hljs-meta >@show</span> id =&gt; d
<span class=hljs-keyword >end</span></code></pre><pre><code class="plaintext hljs">id =&gt; d = 7 =&gt; 0.1f0
id =&gt; d = 4 =&gt; 7.0f0
</code></pre>
<h2 id=dependencies ><a href="#dependencies" class=header-anchor >Dependencies</a></h2>
<pre><code class="plaintext hljs">      Status `~/Research/SimilaritySearchDemos/site-src/Project.toml`
  [053f045d] SimilaritySearch v0.9.2
</code></pre>

<div class=page-foot >
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> Eric S. Tellez <eric.tellez@infotec.mx>. Last modified: March 14, 2022.
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
</div>
</div>
      </div> 
  </div> 
  <script src="/SimilaritySearchDemos/libs/pure/ui.min.js"></script>