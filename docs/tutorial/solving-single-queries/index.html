<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
   <link rel="stylesheet" href="/SimilaritySearchDemos/libs/katex/katex.min.css">
     
   <link rel="stylesheet" href="/SimilaritySearchDemos/libs/highlight/github.min.css">
   
  <link rel="stylesheet" href="/SimilaritySearchDemos/css/franklin.css">
<link rel="stylesheet" href="/SimilaritySearchDemos/css/pure.css">
<link rel="stylesheet" href="/SimilaritySearchDemos/css/side-menu.css">
<!-- style adjustments -->
<style>
.franklin-content{padding-left:10%;}
@media (min-width: 940px) {
  .franklin-content {width: 640px; margin-left: 0px; padding-left: 80px;}
  .header {width: 700px;}
}
</style>
<link rel="icon" href="/SimilaritySearchDemos/assets/favicon.png">

   <title>Solving single queries</title>  
</head>
<body>
  <div id="layout">
    <!-- Menu toggle / hamburger icon -->
    <a href="#menu" id="menuLink" class="menu-link"><span></span></a>
    <div id="menu">
      <div class="pure-menu">
        <a class="pure-menu-heading" href="#">Menu</a>
        <ul class="pure-menu-list">
          <li class="pure-menu-item "><a href="/SimilaritySearchDemos/" class="pure-menu-link">Home</a></li>
          <li class="pure-menu-item "><a href="/SimilaritySearchDemos/tutorials/" class="pure-menu-link">Tutorials</a></li>
          <li class="pure-menu-item "><a href="/SimilaritySearchDemos/demos/" class="pure-menu-link">Demonstrations</a></li>
          <li class="pure-menu-item "><a href="/SimilaritySearchDemos/datasets/" class="pure-menu-link">Datasets</a></li>
          <li class="pure-menu-item "><a href="/SimilaritySearchDemos/tags/" class="pure-menu-link">Tags</a></li>
        </ul>
      </div>
    </div>
    <div id="main"> <!-- Closed in foot -->
      <div class="header">
        <h1>Solving single queries</h1>
        <h2>Usage demonstrations of `SimilaritySearch` with synthetic and real world data</h2>
      </div>


<!-- Content appended here -->
<div class="franklin-content"><div class="franklin-toc"><ol><li><a href="#solving_single_queries_and_knnresult">Solving single queries and <code>KnnResult</code></a></li><li><a href="#knnresult"><code>KnnResult</code></a></li><li><a href="#dependencies">Dependencies</a></li></ol></div>

<h2 id="solving_single_queries_and_knnresult"><a href="#solving_single_queries_and_knnresult" class="header-anchor">Solving single queries and <code>KnnResult</code></a></h2>
<p>By Eric S. TÃ©llez</p>
<pre><code class="language-julia">using SimilaritySearch</code></pre>
<p>This example shows how to perform single queries instead of solving a batch of them. This is particularly useful for some applications, and we also show how they are solved, which could be used to avoid some memory allocations.</p>
<pre><code class="language-julia">const dim &#61; 8

db &#61; MatrixDatabase&#40;randn&#40;Float32, dim, 10^4&#41;&#41;
dist &#61; SqL2Distance&#40;&#41;
G &#61; SearchGraph&#40;; dist, db, verbose&#61;false&#41;
index&#33;&#40;G&#41;</code></pre>
<p>Suppose you want to compute some <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> nearest neighbors, for this we use the structure <code>KnnResult</code> which is a priority queue of maximum size <code>k</code>.</p>
<pre><code class="language-julia">res &#61; KnnResult&#40;3&#41; # allocates memory for 10 nearest neighbors
for v in rand&#40;db, 10&#41;
    global res &#61; reuse&#33;&#40;res&#41;  # reuses the res object
    @time search&#40;G, v, res&#41;
    @show minimum&#40;res&#41;, maximum&#40;res&#41;, argmin&#40;res&#41;, argmax&#40;res&#41;
    @show res.id, res.dist
end</code></pre><pre><code class="plaintext code-output">  0.000014 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 0.8905508f0, 2128, 1443)
(res.id, res.dist) = (Int32[2128, 8344, 1443], Float32[0.0, 0.84609, 0.8905508])
  0.000017 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 1.6256907f0, 2423, 2429)
(res.id, res.dist) = (Int32[2423, 9745, 2429], Float32[0.0, 1.4638197, 1.6256907])
  0.000003 seconds (3 allocations: 80 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (4.78367f0, 5.1175313f0, 4013, 1596)
(res.id, res.dist) = (Int32[4013, 4263, 1596], Float32[4.78367, 4.8129697, 5.1175313])
  0.000008 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 0.41689724f0, 9146, 9665)
(res.id, res.dist) = (Int32[9146, 7734, 9665], Float32[0.0, 0.40764204, 0.41689724])
  0.000009 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 0.58236307f0, 7017, 8663)
(res.id, res.dist) = (Int32[7017, 7083, 8663], Float32[0.0, 0.5803072, 0.58236307])
  0.000006 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 1.6216689f0, 1204, 4870)
(res.id, res.dist) = (Int32[1204, 7732, 4870], Float32[0.0, 1.2965301, 1.6216689])
  0.000003 seconds (3 allocations: 80 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (4.8486495f0, 5.066002f0, 9337, 1662)
(res.id, res.dist) = (Int32[9337, 4890, 1662], Float32[4.8486495, 4.9212174, 5.066002])
  0.000009 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 0.6915525f0, 6818, 1745)
(res.id, res.dist) = (Int32[6818, 4908, 1745], Float32[0.0, 0.2793303, 0.6915525])
  0.000009 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 1.7419999f0, 377, 8083)
(res.id, res.dist) = (Int32[377, 4924, 8083], Float32[0.0, 1.697232, 1.7419999])
  0.000009 seconds (5 allocations: 176 bytes)
(minimum(res), maximum(res), argmin(res), argmax(res)) = (0.0f0, 0.90013003f0, 8798, 6576)
(res.id, res.dist) = (Int32[8798, 1536, 6576], Float32[0.0, 0.87009954, 0.90013003])
</code></pre>
<h2 id="knnresult"><a href="#knnresult" class="header-anchor"><code>KnnResult</code></a></h2>
<p>This structure is the container for the result and it is also used to specify the number of elements to retrieve. As mentioned before, it is a priority queue</p>
<pre><code class="language-julia">res &#61; reuse&#33;&#40;res&#41;
push&#33;&#40;res, 1, 10&#41;
push&#33;&#40;res, 2, 9&#41;
push&#33;&#40;res, 3, 8&#41;
push&#33;&#40;res, 4, 7&#41;
push&#33;&#40;res, 6, 5&#41;
@show res</code></pre><pre><code class="plaintext code-output">res = SimilaritySearch.KnnResult(Int32[6, 4, 3], Float32[5.0, 7.0, 8.0], 3)
</code></pre>
<p>it also supports removals</p>
<pre><code class="language-julia">@show :popfirst&#33; &#61;&gt; popfirst&#33;&#40;res&#41;
push&#33;&#40;res, 7, 0.1&#41;
@show :push&#33; &#61;&gt; res
@show :pop&#33; &#61;&gt; pop&#33;&#40;res&#41;
res</code></pre><pre><code class="plaintext code-output">:popfirst! => popfirst!(res) = :popfirst! => (6 => 5.0f0)
:push! => res = :push! => SimilaritySearch.KnnResult(Int32[7, 4, 3], Float32[0.1, 7.0, 8.0], 3)
:pop! => pop!(res) = :pop! => (3 => 8.0f0)
SimilaritySearch.KnnResult(Int32[7, 4], Float32[0.1, 7.0], 3)</code></pre>
<p>It can be iterated</p>
<pre><code class="language-julia">for &#40;id, d&#41; in res
    @show id &#61;&gt; d
end</code></pre><pre><code class="plaintext code-output">id => d = 7 => 0.1f0
id => d = 4 => 7.0f0
</code></pre>
<h2 id="dependencies"><a href="#dependencies" class="header-anchor">Dependencies</a></h2>
<pre><code class="plaintext code-output">      Status `~/Research/SimilaritySearchDemos/site-src/Project.toml`
  [053f045d] SimilaritySearch v0.9.2
</code></pre>

<div class="page-foot">
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> Eric S. Tellez <eric.tellez@infotec.mx>. Last modified: March 14, 2022.
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
</div>
</div><!-- CONTENT ENDS HERE -->
      </div> <!-- end of id=main -->
  </div> <!-- end of id=layout -->
  <script src="/SimilaritySearchDemos/libs/pure/ui.min.js"></script>
  
      



  
  
      <script src="/SimilaritySearchDemos/libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>

  
</body>
</html>
