<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/SimilaritySearchDemos/libs/katex/katex.min.css"> <link rel=stylesheet  href="/SimilaritySearchDemos/libs/highlight/github.min.css"> <link rel=stylesheet  href="/SimilaritySearchDemos/css/franklin.css"> <link rel=stylesheet  href="/SimilaritySearchDemos/css/pure.css"> <link rel=stylesheet  href="/SimilaritySearchDemos/css/side-menu.css"> <style> .franklin-content{padding-left:10%;} @media (min-width: 940px) { .franklin-content {width: 640px; margin-left: 0px; padding-left: 80px;} .header {width: 700px;} } </style> <link rel=icon  href="/SimilaritySearchDemos/assets/favicon.png"> <title>Incremental construction</title> <div id=layout > <a href="#menu" id=menuLink  class=menu-link ><span></span></a> <div id=menu > <div class=pure-menu > <a class=pure-menu-heading  href="#">Menu</a> <ul class=pure-menu-list > <li class="pure-menu-item "><a href="/SimilaritySearchDemos/" class=pure-menu-link >Home</a> <li class="pure-menu-item "><a href="/SimilaritySearchDemos/tutorials/" class=pure-menu-link >Tutorials</a> <li class="pure-menu-item "><a href="/SimilaritySearchDemos/demos/" class=pure-menu-link >Demonstrations</a> <li class="pure-menu-item "><a href="/SimilaritySearchDemos/datasets/" class=pure-menu-link >Datasets</a> <li class="pure-menu-item "><a href="/SimilaritySearchDemos/tags/" class=pure-menu-link >Tags</a> </ul> </div> </div> <div id=main > <div class=header > <h1>Incremental construction</h1> <h2>Usage demonstrations of `SimilaritySearch` with synthetic and real world data</h2> </div> <div class=franklin-content ><div class=franklin-toc ><ol><li><a href="#all-knn">All-KNN</a><li><a href="#differences_between_allknng_k_and_searchbatchg_x_k">Differences between <code>allknn&#40;G, k&#41;</code> and <code>searchbatch&#40;G, X, k&#41;</code></a><li><a href="#about_the_cost_of_construction_allknn_instead_of_a_brute_force_computation">About the cost of construction &#43; <code>allknn</code> instead of a brute force computation.</a><li><a href="#comparing_solution_times">Comparing solution times</a><li><a href="#quality">Quality</a><li><a href="#final_notes">Final notes:</a><li><a href="#dependencies">Dependencies</a></ol></div> <h2 id=all-knn ><a href="#all-knn" class=header-anchor >All-KNN</a></h2> <p>By Eric S. Téllez</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> SimilaritySearch</code></pre>
<p>Computing the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> nearest neighbors of a dataset &#40;all vs all&#41; is a useful task to take knowledge of a given dataset. This is a core task for some clustering algorithms and non-linear dimensional reduction algorithms.</p>
<p>Given a metric database <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >(</mo><mi>X</mi><mo separator=true >,</mo><mi>d</mi><mi>i</mi><mi>s</mi><mi>t</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">(X, dist)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class=mclose >)</span></span></span></span>  and a relatively small <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> value, the goal is to compute <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >{</mo><mi>k</mi><mi>n</mi><mi>n</mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>∣</mo><mi>x</mi><mo>∈</mo><mi>X</mi><mo stretchy=false >}</mo></mrow><annotation encoding="application/x-tex">\{ knn(x) \mid x \in X \}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >{</span><span class="mord mathnormal">knn</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >∣</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=mclose >}</span></span></span></span> taking into account that each <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>∈</mo><mi>X</mi></mrow><annotation encoding="application/x-tex">x_i \in X</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6891em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2778em;"></span></span><span class=base ><span class=strut  style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>, and therefore, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5806em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> should be removed from the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>-th <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi>n</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">knn</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6944em;"></span><span class="mord mathnormal">knn</span></span></span></span> result set.</p>
<p>Solving <code>allknn</code> fast and accuratelly is the goal of this example.</p>
<pre><code class="julia hljs"><span class=hljs-keyword >const</span> dim = <span class=hljs-number >16</span>
k = <span class=hljs-number >15</span>
verbose = <span class=hljs-literal >false</span>
db = MatrixDatabase(randn(<span class=hljs-built_in >Float32</span>, dim, <span class=hljs-number >10</span>^<span class=hljs-number >5</span>))
dist = SqL2Distance()
G = SearchGraph(; dist, db, verbose)
itime = <span class=hljs-meta >@elapsed</span> (index!(G); optimize!(G, MinRecall(<span class=hljs-number >0.9</span>)))</code></pre>
<p>Now we can solve all <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>nn</p>
<pre><code class="julia hljs">allknntime = <span class=hljs-meta >@elapsed</span> knns, dists = allknn(G, k)</code></pre>
<h2 id=differences_between_allknng_k_and_searchbatchg_x_k ><a href="#differences_between_allknng_k_and_searchbatchg_x_k" class=header-anchor >Differences between <code>allknn&#40;G, k&#41;</code> and <code>searchbatch&#40;G, X, k&#41;</code></a></h2>
<p>We can solve similarly with <code>searchbatch</code> but self-references should be removed later, and more important, <code>allknn</code> use special pivoting/boosting strategies that yields to faster searches.</p>
<pre><code class="julia hljs">searchtime = <span class=hljs-meta >@elapsed</span> sknns, sdists = searchbatch(G, db, k)</code></pre>
<h2 id=about_the_cost_of_construction_allknn_instead_of_a_brute_force_computation ><a href="#about_the_cost_of_construction_allknn_instead_of_a_brute_force_computation" class=header-anchor >About the cost of construction &#43; <code>allknn</code> instead of a brute force computation.</a></h2>
<p><code>allknn</code> for <code>ExhaustiveSearch</code> doesn&#39;t perform any optimization but removes self references.</p>
<pre><code class="julia hljs">etime = <span class=hljs-meta >@elapsed</span> eknns, edists = allknn(ExhaustiveSearch(; db, dist), k)</code></pre>
<h2 id=comparing_solution_times ><a href="#comparing_solution_times" class=header-anchor >Comparing solution times</a></h2>
<p>indexing, allknn, and searchbatch times</p>
<pre><code class="julia hljs">itime, allknntime, searchtime</code></pre><pre><code class="plaintext hljs">(5.040281815, 1.043150425, 0.48428813)</code></pre>
<p>full cost <code>allknn</code></p>
<pre><code class="julia hljs">itime + allknntime</code></pre><pre><code class="plaintext hljs">6.0834322400000005</code></pre>
<p>full cost <code>searchbatch</code></p>
<pre><code class="julia hljs">itime + searchtime</code></pre><pre><code class="plaintext hljs">5.5245699450000005</code></pre>
<p>exhaustive <code>allknn</code></p>
<pre><code class="julia hljs">etime</code></pre><pre><code class="plaintext hljs">6.325815174</code></pre>
<h2 id=quality ><a href="#quality" class=header-anchor >Quality</a></h2>
<p>macro recall of <code>allknn</code></p>
<pre><code class="julia hljs">macrorecall(eknns, knns)</code></pre><pre><code class="plaintext hljs">0.9139300000006781</code></pre>
<p>macro recall of <code>searchbatch</code></p>
<pre><code class="julia hljs">macrorecall(eknns, sknns)</code></pre><pre><code class="plaintext hljs">0.914159333334015</code></pre>
<h2 id=final_notes ><a href="#final_notes" class=header-anchor >Final notes:</a></h2>
<p>Exhaustive search will fetch the exact solution but it has a higher cost and this could be more notorious as dataset&#39;s size increases.</p>
<p>Also note that even <code>SimilaritySearch</code> has multithreading operations, it runs in a single thread due to the html generation pipeline.</p>
<h2 id=dependencies ><a href="#dependencies" class=header-anchor >Dependencies</a></h2>
<pre><code class="plaintext hljs">Status `~/Research/SimilaritySearchDemos/site-src/Project.toml`
  [053f045d] SimilaritySearch v0.10.8
</code></pre>

<div class=page-foot >
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> Eric S. Tellez <eric.tellez@infotec.mx>. Last modified: March 15, 2022.
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
</div>
</div>
      </div> 
  </div> 
  <script src="/SimilaritySearchDemos/libs/pure/ui.min.js"></script>